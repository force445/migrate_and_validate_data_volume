---
- name: Scale down deployments
  kubernetes.core.k8s:
    kind: Deployment
    api_version: apps/v1
    name: ""
    namespace: ""
    replicas: 0

- name: Create PVC migration Job (mnt2)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: "{{ migration_job_name }}"
        namespace: "{{ namespace }}"
      spec:
        backoffLimit: 0
        template:
          spec:
            restartPolicy: Never
            containers:
              - name: rsync
                image: "{{ rsync_image }}"
                command:
                  - /bin/sh
                  - -c
                  - |
                    set -e
                    echo "Starting rsync..."
                    rsync -aHAX --numeric-ids --delete \
                      {{ source_mount_path }}/ \
                      {{ destination_mount_path }}/
                    echo "Rsync completed"
                volumeMounts:
                  - name: source
                    mountPath: "{{ source_mount_path }}"
                  - name: destination
                    mountPath: "{{ destination_mount_path }}"
            volumes:
              - name: source
                persistentVolumeClaim:
                  claimName: "{{ source_pvc }}"
              - name: destination
                persistentVolumeClaim:
                  claimName: "{{ destination_pvc }}"

- name: Wait for migration Job to complete
  kubernetes.core.k8s_info:
    kind: Job
    namespace: "{{ namespace }}"
    name: "{{ migration_job_name }}"
  register: job_info
  until: >
    job_info.resources[0].status.succeeded is defined
    and job_info.resources[0].status.succeeded == 1
  retries: 60
  delay: 5

- name: Fail if migration Job failed
  ansible.builtin.fail:
    msg: "PVC migration job failed"
  when: >
    job_info.resources[0].status.failed is defined
    and job_info.resources[0].status.failed > 0

