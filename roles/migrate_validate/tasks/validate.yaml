- name: Validate file count (source)
  ansible.builtin.command: >
    kubectl exec -n {{ namespace }} {{ migration_pod_name }}
    -- sh -c "find /data-old -type f | wc -l"
  register: src_count
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Validate file count (destination)
  ansible.builtin.command: >
    kubectl exec -n {{ namespace }} {{ migration_pod_name }}
    -- sh -c "find /data-new -type f | wc -l"
  register: dst_count
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Assert file counts match
  ansible.builtin.assert:
    that:
      - src_count.stdout == dst_count.stdout

- name: Delete migration pod
  kubernetes.core.k8s:
    state: absent
    kind: Pod
    namespace: "{{ namespace }}"
    name: "{{ migration_pod_name }}"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"