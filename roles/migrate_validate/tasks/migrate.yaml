- name: Create migration pod
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Pod
      metadata:
        name: "{{ migration_pod_name }}"
        namespace: "{{ namespace }}"
      spec:
        restartPolicy: Never
        securityContext:
          fsGroup: "{{ fs_group }}"
        containers:
          - name: shell
            image: instrumentisto/rsync-ssh
            command: ["sh", "-c", "sleep infinity"]
            securityContext:
              runAsUser: 0
            volumeMounts:
              - name: source
                mountPath: /data-old
              - name: destination
                mountPath: /data-new
        volumes:
          - name: source
            persistentVolumeClaim:
              claimName: "{{ source_pvc }}"
          - name: destination
            persistentVolumeClaim:
              claimName: "{{ destination_pvc }}"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Wait for migration pod
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ namespace }}"
    name: "{{ migration_pod_name }}"
  register: pod
  until: 
    - pod.resources[0].status.phase == "Running"
    - pod.resources[0].status.containerStatuses is defined
    - pod.resources[0].status.containerStatuses[0].ready == true
  retries: 30
  delay: 5
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Rsync via kubectl exec
  ansible.builtin.command: >
    kubectl exec -n {{ namespace }} {{ migration_pod_name }}
    -- rsync -aHAX --numeric-ids --delete /data-old/ /data-new/
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
